<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Data, Power, and Consent in the DeepMind–NHS Streams Partnership – Rachel Zayar</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Rachel Zayar</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./resume.html"> 
<span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-data-viz-gallery" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Data Viz Gallery</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-data-viz-gallery">    
        <li>
    <a class="dropdown-item" href="./tidytuesday1.html">
 <span class="dropdown-text">BBC 100 Women 2020</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./tidytuesday2.html">
 <span class="dropdown-text">SF Street Trees</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./project2.html"> 
<span class="menu-text">Love in Romeo &amp; Juliet</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./project3.html"> 
<span class="menu-text">Asia vs Other: 2020 Life Expectancy</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./project4.html" aria-current="page"> 
<span class="menu-text">DeepMind–NHS Ethics</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./project5.html"> 
<span class="menu-text">Sex Differences and Traffic Stops</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#consent-and-permission-structures" id="toc-consent-and-permission-structures" class="nav-link" data-scroll-target="#consent-and-permission-structures">1. Consent and Permission Structures</a></li>
  <li><a href="#data-privacy-and-identifiability" id="toc-data-privacy-and-identifiability" class="nav-link" data-scroll-target="#data-privacy-and-identifiability">2. Data Privacy and Identifiability</a></li>
  <li><a href="#representation-and-bias-in-algorithm-design" id="toc-representation-and-bias-in-algorithm-design" class="nav-link" data-scroll-target="#representation-and-bias-in-algorithm-design">3. Representation and Bias in Algorithm Design</a></li>
  <li><a href="#data-use-beyond-original-intent" id="toc-data-use-beyond-original-intent" class="nav-link" data-scroll-target="#data-use-beyond-original-intent">4. Data Use Beyond Original Intent</a></li>
  <li><a href="#why-it-matters" id="toc-why-it-matters" class="nav-link" data-scroll-target="#why-it-matters">5. Why It Matters</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Data, Power, and Consent in the DeepMind–NHS Streams Partnership</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In 2015, the Royal Free London NHS Foundation Trust, a large public hospital group within the United Kingdom’s tax‑funded National Health Service (NHS), partnered with Google DeepMind, an artificial‑intelligence lab owned by Alphabet, to develop Streams, a smartphone app intended to alert clinicians in real time when patients showed signs of acute kidney injury. To build and test Streams, DeepMind received access to the medical records of approximately 1.6 million NHS patients, including highly sensitive information such as HIV status, mental health history, and drug‑use data. (Powles &amp; Hodson, 2017).</p>
<p>What began as a promising digital‑health initiative quickly became one of the UK’s most controversial data‑science collaborations when it emerged that patients had not been told their records would be shared with a private company and had not consented to this use. In 2017, the UK’s Information Commissioner’s Office (ICO), the national regulator for data‑protection and privacy, concluded that the partnership violated data‑protection law because the data had been shared under the justification of “direct patient care,” even though Streams was still being tested and was not yet part of routine care.(University of Cambridge, 2019).</p>
<p>This partnership became a defining example of how ethics, power, and corporate interests intersect in artificial intelligence research. It showed that technological innovation in healthcare cannot be separated from the moral questions surrounding ownership, consent, and the use of personal data.</p>
</section>
<section id="consent-and-permission-structures" class="level2">
<h2 class="anchored" data-anchor-id="consent-and-permission-structures">1. Consent and Permission Structures</h2>
<p><strong>Questions addressed:</strong> What was the permission structure for using the data? Was it followed? What was the consent structure for patients? Were they aware of how their data would be used? Is informed consent possible for unforeseen future applications?</p>
<p>Under the UK Data Protection Act, organizations must have a valid legal basis for processing personal data. The Royal Free Trust argued that sharing data with DeepMind was justified under “direct patient care,” the same basis that allows clinicians to access records to diagnose and treat individuals. However, Streams was in a research and testing phase; patients were not yet receiving care through the app, so this legal justification did not apply.</p>
<p>In 2017, the ICO found that the Royal Free Trust had failed to adequately inform patients about the partnership or the ways their data would be processed. Patients were not told that a private AI lab would receive their records, nor were they given a meaningful chance to opt in or out. Genuine informed consent requires that people know who will access their data, for what purposes, and with what potential consequences. In this case, patients had no realistic way to understand that their records might support algorithm development, later products, or broader commercial AI strategies.</p>
<p>More broadly, the case highlights the limits of conventional consent models in big‑data healthcare. Fan, Zhang, and Li (2025) argue that when AI enables open‑ended reuse of data, future applications are often impossible to foresee at the point of collection. The DeepMind collaboration demonstrates how quickly clinical data, obtained for treatment and operations, can be repurposed for research and development far beyond what patients initially understood.</p>
</section>
<section id="data-privacy-and-identifiability" class="level2">
<h2 class="anchored" data-anchor-id="data-privacy-and-identifiability">2. Data Privacy and Identifiability</h2>
<p><strong>Questions addressed:</strong> Is the data identifiable? Are parts of it sufficiently anonymized to avoid ethical concerns? Is anonymity realistically guaranteed?</p>
<p>DeepMind received rich, line‑level health records from the Royal Free, including names, addresses, dates, and detailed medical histories. Although the organizations stressed that the data were stored and processed securely, the ICO concluded that the scale and identifiability of the dataset went well beyond what was necessary for testing Streams.</p>
<p>Even where explicit identifiers are removed, true anonymity in health data is difficult to achieve. Murdoch (2021) notes that combinations of diagnoses, dates, demographics, and geography can re‑identify individuals when linked with other datasets. A small set of quasi‑identifiers, such as age, postcode, and rare conditions, can be enough to single out a person.</p>
<p>In the Streams case, DeepMind’s access to identifiable or easily re‑identifiable records without explicit patient consent represented a clear privacy risk. It exposed weaknesses in data‑governance processes around data minimization (only using what is strictly necessary), independent oversight, and clarity about who is accountable when public providers share health records with private AI developers.</p>
</section>
<section id="representation-and-bias-in-algorithm-design" class="level2">
<h2 class="anchored" data-anchor-id="representation-and-bias-in-algorithm-design">3. Representation and Bias in Algorithm Design</h2>
<p><strong>Questions addressed:</strong> Who was measured? Are these patients representative of the broader populations where the algorithm might be used? Should we analyze data if we know the sample is narrow?</p>
<p>The training data for Streams came from a single hospital trust in London, which limited the demographic and clinical diversity of the dataset. Algorithms built on such a narrow population may not perform well for patients in other regions, health‑system contexts, or with different ethnic and socioeconomic backgrounds.</p>
<p>Dankwa‑Mullan et al.&nbsp;(2024) emphasize that AI tools trained on unrepresentative data can reproduce and intensify existing health inequities, especially when they are deployed at scale without rigorous external validation. D’Ignazio and Klein’s (2020) Data Feminism framework similarly stresses examining who is included and excluded in a dataset, and how those choices reflect existing power structures and systemic bias.</p>
<p>Because Streams was trained primarily on patients from one trust, its fairness and reliability for other NHS populations were uncertain from the outset. Yet the project attracted national and international attention as a model of “AI for healthcare,” illustrating how quickly tools based on local data can be implicitly generalized to much broader contexts.</p>
</section>
<section id="data-use-beyond-original-intent" class="level2">
<h2 class="anchored" data-anchor-id="data-use-beyond-original-intent">4. Data Use Beyond Original Intent</h2>
<p><strong>Question addressed:</strong> Is the data being used in ways that go beyond the purposes for which it was originally collected?</p>
<p>The NHS collects patient records to deliver care, manage services, and meet legal obligations, not to provide a general data resource for private AI labs. In the DeepMind partnership, however, information originally gathered for clinical purposes was repurposed to develop and test a machine‑learning system owned by a subsidiary of a large technology company.</p>
<p>DeepMind described Streams as a non‑commercial patient‑safety project, but Alphabet nonetheless benefited from technical expertise, infrastructure, and potential intellectual property generated through the collaboration. Fan et al.&nbsp;(2025) argue that in such arrangements, public institutions often provide the data while private firms capture most of the long‑term value in the form of algorithms, know‑how, and future products. Patients whose data made the work possible rarely participate in decisions about reuse and typically do not share in any commercial benefits.</p>
<p>From a Data Feminism perspective, this reflects a structural power imbalance between public healthcare systems and corporate technology actors. Public providers depend on large technology firms for AI tools and infrastructure, while those firms gain influence over public infrastructure through control of data and models. The Streams case shows how easily public health data can be drawn into private research agendas once consent and governance safeguards fail.</p>
</section>
<section id="why-it-matters" class="level2">
<h2 class="anchored" data-anchor-id="why-it-matters">5. Why It Matters</h2>
<p><strong>Questions addressed</strong>: “Who benefits? Who is neglected or harmed? Were the ethical violations in the interest of profit, surveillance, or power?”</p>
<p>In principle, tools like Streams can improve patient outcomes by flagging kidney injury earlier and helping clinicians intervene more quickly. In practice, the way this collaboration was structured concentrated benefits and risks unevenly. Alphabet gained access to a large, high‑quality dataset and an opportunity to develop AI capabilities in a high‑profile clinical setting. Patients, by contrast, lost control over sensitive information and were exposed to privacy risks without their knowledge or consent.</p>
<p>Because the data came from one trust and patients had no role in governance, the project also risked reinforcing inequities; improving care for some groups while leaving others unserved or mis‑served. As D’Ignazio and Klein (2020) argue, ethical data science is not only about meeting legal requirements; it also demands attention to fairness, accountability, and the protection of those with the least power.</p>
<p>The DeepMind–Royal Free case ultimately serves as a cautionary tale. Inadequate consent, insufficient anonymization, narrow training data, and repurposing of patient records for corporate AI development all reveal how easily technological innovation can outpace ethical and regulatory safeguards. Without stronger consent mechanisms, transparent governance, more representative data, and fair sharing of benefits, AI in healthcare risks reproducing the very power imbalances and inequities it claims to address.</p>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>
<p>References</p>
<p>Dankwa-Mullan, I., Nunez-Smith, M., &amp; Volerman, A. (2024). Health equity and ethical considerations in using artificial intelligence. Centers for Disease Control and Prevention. https://www.cdc.gov/pcd/issues/2024/24_0245.htm</p>
<p>D’Ignazio, C., &amp; Klein, L. F. (2020). Data feminism. MIT Press.</p>
<p>Fan, X., Zhang, L., &amp; Li, Y. (2025). Exploring the ethical issues posed by AI and big data in healthcare. Frontiers in Public Health, 13, 1585180. https://doi.org/10.3389/fpubh.2025.1585180</p>
<p>Murdoch, B. (2021). Privacy and artificial intelligence: Challenges for protecting health data. BMC Medical Ethics, 22(122). https://doi.org/10.1186/s12910-021-00687-3</p>
<p>Powles, J., &amp; Hodson, H. (2017). Google DeepMind and healthcare in an age of algorithms. Health and Technology, 7(4), 351–367. https://doi.org/10.1007/s12553-017-0179-1</p>
<p>University of Cambridge. (2019, July 16). Royal Free London NHS Trust–Google DeepMind deal is “cautionary tale” for healthcare in the algorithmic age. https://www.cam.ac.uk/research/news/deepmind-royal-free-deal-is-cautionary-tale-for-healthcare-in-the-algorithmic-age</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>